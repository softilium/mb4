{% extends "layout.html" %}

{% block title %}Strategy{% endblock %}

{% block content %}

<div id="vueapp">

    <div class="row">

        <div class="col-12 col-xl-6">

            <button class="btn btn-primary btn-sm" v-on:click="putStrategy">Apply</button>

            <ul class="nav nav-tabs" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-main-tab" data-bs-toggle="pill" data-bs-target="#pills-main" type="button" role="tab"
                        aria-controls="pills-main" aria-selected="true">Main</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-shares-tab" data-bs-toggle="pill" data-bs-target="#pills-shares" type="button" role="tab"
                        aria-controls="pills-shares" aria-selected="false">Fixed shares</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-factors-tab" data-bs-toggle="pill" data-bs-target="#pills-factors" type="button" role="tab"
                        aria-controls="pills-factors" aria-selected="false">Factors</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-filters-tab" data-bs-toggle="pill" data-bs-target="#pills-filters" type="button" role="tab"
                        aria-controls="pills-filters" aria-selected="false">Filters</button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">

                <div class="tab-pane fade show active" id="pills-main" role="tabpanel" aria-labelledby="pills-main-tab">
                    <div id="strategyForm">
                        <small>
                            <div class="form-group form-group-sm row">
                                <label for="descr" class="col-sm-3 col-form-label">Name</label>
                                <div class="col-sm-9">
                                    <input class="form-control input-sm form-control-sm" type="text" v-model="obj.Descr" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col">

                                    <div class="form-group row">
                                        <label for="maxtickers" class="col-sm-6 col-form-label">Max. tickers</label>
                                        <div class="col-sm-6">
                                            <input class="form-control form-control-sm" type='number' v-model='obj.MaxTickers' />
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label for="startAmount" class="col-sm-6 col-form-label">Start cash</label>
                                        <div class="col-sm-6">
                                            <input class="form-control form-control-sm" type='number' v-model='obj.StartAmount' />
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label for="weekRefillAmount" class="col-sm-6 col-form-label">Weekly top-up</label>
                                        <div class="col-sm-6">
                                            <input class="form-control form-control-sm" type='number' v-model='obj.WeekRefillAmount' />
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label for="startSimulation" class="col-sm-6 col-form-label">Start simulation date</label>
                                        <div class="col-sm-6">
                                            <input class="form-control form-control-sm" type='date' v-model='obj.StartSimulation' />
                                        </div>
                                    </div>

                                    <div class="'form-group row">
                                        <label for="baseIndex" class="col-sm-6 col-form-label">Base for calc alpha</label>
                                        <div class="col-sm-6">
                                            <select class="form-select form-control-sm" v-model='obj.BaseIndex'>
                                                <option></option>
                                                <option v-for="item in renderInfo.Tickers" v-bind:value="item.Id">
                                                    ${item.Descr}
                                                </option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label for="SameEmitent" class="col-sm-6 col-form-label">Same emitent tickers</label>
                                        <div class="col-sm-6">
                                            <select class="form-select form-control-sm" v-model='obj.SameEmitent'>
                                                <option v-for="item in renderInfo.SameEmitentPolicies" v-bind:value="item.Id">${item.Descr}</option>
                                            </select>
                                        </div>
                                    </div>

                                </div>
                                <div class="col">
                                    <div class="form-group row">
                                        <label for="allowLossWhenSell" class="col-sm-6 col-form-check-label">
                                            Allow loss when sell
                                        </label>
                                        <div class="col-sm-6">
                                            <input class="form-check-input form-control-sm" type="checkbox" v-model='obj.AllowLossWhenSell' />
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label for="buyOnlyLowPrice" class="col-sm-6 col-form-label">Buy only lower price</label>
                                        <div class="col-sm-6">
                                            <input class="form-check-input form-control-sm" type="checkbox" v-model='obj.BuyOnlyLowPrice' />
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label for="AllowSellToFit" class="col-sm-6 col-form-label">
                                            Allow partial sell to fit
                                        </label>
                                        <div class="col-sm-6">
                                            <input class="form-check-input form-control-sm" type="checkbox" v-model='obj.AllowSellToFit' />
                                        </div>
                                    </div>

                                </div>
                            </div>

                        </small>
                    </div>
                </div>

                <div class="tab-pane fade show" id="pills-shares" role="tabpanel" aria-labelledby="pills-shares-tab">
                    <strategy-fixed-tickers :strategy='obj' :renderinfo='renderInfo' />
                </div>

                <div class="tab-pane fade show" id="pills-factors" role="tabpanel" aria-labelledby="pills-factors-tab">
                    <strategy-factors :strategy='obj' :renderinfo='renderInfo' />
                </div>

                <div class="tab-pane fade show" id="pills-filters" role="tabpanel" aria-labelledby="pills-filters-tab">
                    <strategy-filters :strategy='obj' :renderinfo='renderInfo' />
                </div>

            </div>

        </div>

        <div class="col-12 col-xl-6" v-if="results != null && results.ActualPortfolio != null">

            <h2>Today portfolio</h2>

            <p>Cash: ${ $prnCurrency(results.ActualPortfolio.Cash) } </p>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Тикер</th>
                        <th class="text-end">%</th>
                        <th class="text-end">Qty</th>
                        <th class="text-end">Lots</th>
                        <th v-for="f in obj.edges.Factors" class="text-end">Factor ${ f.LineNum }<br />${ factorDescr(f) }</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="item in results.ActualPortfolio.Items">
                        <td><a v-bind:href="tickerUrl(item.Ticker.id)">${item.Ticker.Descr}</a></td>
                        <td class="text-end">${ $prnPercent1(item.CurrentPercent) }</td>
                        <td class="text-end">${ $prnCurrency(item.Balance) }</td>
                        <td class="text-end">${ item.Lots }</td>
                        <td v-for="f in obj.edges.Factors" class="text-end">${ $prnPercent1(item.DebugFactors[f.LineNum]) }</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <br></br>
    <div class="row">
        <div class="col-12 col-lg-6">
            <div ref="strategyChartRef" style="height:400px;width:100%"></div>
        </div>
        <div class="col-12 col-lg-6" v-if="obj.BaseIndex != null && obj.BaseIndex !='' ">
            <div ref="PerformanceChartRef" style="height:400px;width:100%"></div>
        </div>
    </div>

    <div class='row' v-if='results.IndustryTradeResults!=null'>
        <div class="row">
            <div class="col-12 col-xl-5">
                <h2>Profit by industries: ${ $prnCurrency(results.ProfitTotal) }</h2>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Industry</th>
                            <th class="text-end">Profit</th>
                            <th class="text-end">Trades</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for='item in results.IndustryTradeResults'>
                            <td> <a v-bind:href="industryUrl(item.IndustryId)">${item.IndustryDesc}</a> </td>
                            <td class="text-end">${ $prnCurrency(item.Profit) }</td>
                            <td class="text-end">${item.DealsCount}</td>
                        </tr>
                    </tbody>
                </table>

            </div>
            <div class="col-12 col-xl-7">
                <h2>Dividends by industries: ${ $prnCurrency(results.DivsTotal) } </h2>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Industry</th>
                            <th class="text-end" v-for='y in results.YearsInResult'>${y}</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for='item in results.IndustryDividendResults'>
                            <td><a v-bind:href="industryUrl(item.Industry.id)">${item.Industry.Descr}</a></td>
                            <td class="text-end" v-for='y in results.YearsInResult'>
                                ${ $prnCurrency(sumDivByYearForIndustry(y, item.Industry.id)) }
                            </td>
                            <td class="text-end">${ $prnCurrency(sumDivForIndustry(item.Industry.id)) } </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td>Total</td>
                            <td class="text-end" v-for='y in results.YearsInResult'>
                                ${ $prnCurrency(sumDivByYearForIndustry(y, null)) }
                            </td>
                            <td class="text-end">${ $prnCurrency(results.DivsTotal) } </td>
                        </tr>
                    </tfoot>
                </table>

            </div>
        </div>
    </div>

    <div class=row v-if='!results!=null && results.TickerTradeResults != null'>

        <div class="col-12 col-xl-5">
            <h2>Profit: ${ $prnCurrency(results.ProfitTotal) }</h2>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th class="text-end">Profit</th>
                        <th class="text-end">Trades</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for='item in results.TickerTradeResults'>
                        <td><a v-bind:href="tickerUrl(item.TickerId)">${item.TickerDescr}</a></td>
                        <td class='text-end'>${ $prnCurrency(item.Profit) }</td>
                        <td class='text-end'>${item.DealsCount}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="col-12 col-xl-7">
            <h2>Dividends: ${ $prnCurrency(results.DivsTotal) }</h2>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th class="text-end" v-for='y in results.YearsInResult'>${y}</th>
                        <th class="text-end">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for='item in results.TickerDividendResults'>
                        <td><a v-bind:href="tickerUrl(item.Ticker.id)">${item.Ticker.Descr}</a></td>
                        <td class="text-end" v-for='y in results.YearsInResult'>
                            ${ $prnCurrency(sumDivByYearForTicker(y, item.Ticker.id)) }
                        </td>
                        <td class="text-end">${ $prnCurrency(sumAllYears(item)) }</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td>Total</td>
                        <td class="text-end" v-for='y in results.YearsInResult'>
                            ${ $prnCurrency(sumDivByYearForTickerAll(y)) }</td>
                        <td class="text-end">${ $prnCurrency(results.DivsTotal) }</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div class="row" v-if='selectedYear != null'>
        <div class="col">
            <h2>Simulation results</h2>

            <div>
                <button v-for='y in results.YearsInResult' class="btn btn-xs"
                    v-bind:class="{ 'btn-primary': y==selectedYear, 'btn-link': y!=selectedYear }" v-on:click='setSelectedYear(y)'>
                    ${y}
                </button>
            </div>
            <small>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th class="text-end">Top-up</th>
                            <th>Trades</th>
                            <th class="text-end">Cash</th>
                            <th class="text-end">Balance</th>
                            <th class="text-end">Invested  accum.</th>
                            <th class="text-end">Dividends accum.</th>
                            <th class="text-end">Result accum.</th>
                            <th class="text-end">Yield accum.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for='item in daysForYear(selectedYear)'>
                            <td>${new Date(item.D).toLocaleDateString()}</td>
                            <td class="text-end">${ $prnCurrency(item.Refill) }</td>
                            <td>
                                <div v-for='deal in item.Deals'>
                                    <span v-if='deal.Kind==100'
                                        v-bind:class="{'text-danger': deal.InvestResult<0, 'text-success': deal.InvestResult>=0 }">
                                        sell ${deal.TickerId} ${deal.Lots} lot(s), ${ $prnCurrency(deal.InvestResult) }
                                    </span>
                                    <span v-if='deal.Kind==200'>
                                        buy ${deal.TickerId} ${deal.Lots} lot(s)
                                    </span>
                                </div>
                            </td>
                            <td class="text-end">${ $prnCurrency(item.PortfolioCash) }</td>
                            <td class="text-end">${ $prnCurrency(item.PortfolioBalance) }</td>
                            <td class="text-end">${ $prnCurrency(item.Accu_Equity) }</td>
                            <td class="text-end">${ $prnCurrency(item.Accu_Dividends) }</td>
                            <td class="text-end">${ $prnCurrency(item.Accu_InvestResult) }</td>
                            <td class="text-end">${ $prnCurrency(item.Accu_Yield) }</td>
                        </tr>
                    </tbody>
                </table>
            </small>
        </div>
    </div>

</div>

{% include "components/StrategyFilters.html" %}
{% include "components/StrategyFactors.html" %}
{% include "components/StrategyFixedTickers.html" %}

<script type="text/javascript">

    window.strategyId = '{{pd.StrategyId}}';

    const App = {
        delimiters: ['${', '}'],
        data() {
            return {
                obj: {
                    edges: {
                        FixedTickers: []
                    }
                },
                results: {},
                selectedYear: null,
                renderInfo: {
                    ReportValues: [],
                    SameEmitentPolicies: [],
                    FilterValueKinds: [],
                    FilterOps: [],
                    FilterOpsShort: [],
                    Industries: [],
                    ReportValueTypes: [],
                }
            }
        },
        components: {
            StrategyFilters: StrategyFilters,
            StrategyFactors: StrategyFactors,
            StrategyFixedTickers: StrategyFixedTickers
        },

        async mounted() {
            await this.getStrategy();
            await this.getResults();
        },
        watch: {
            results: {
                async handler(newVal, oldVal) {
                    await this.$nextTick();
                    this.createStrategyChart(this.$refs.strategyChartRef, this.results.Dates, this.results.Equity, this.results.InvestResults, this.results.Divs);
                    if (this.obj.BaseIndex != null && this.obj.BaseIndex != '')
                        this.createStrategyPerformanceChart(this.$refs.PerformanceChartRef, this.results.Dates, this.results.StrategyLevels, this.results.BaseLevels);
                }
            }
        },
        methods: {

            createStrategyChart: function (element, dates, equity, results, alldivs) {

                var myChart = echarts.init(element);

                option = {
                    legend: {
                        data: ['Equity', 'Dividends', 'Result'],
                        left: 10
                    },
                    tooltip: {},
                    xAxis: {
                        data: dates,
                        name: 'Weeks',
                        axisLine: { onZero: true },
                        splitLine: { show: false },
                        splitArea: { show: false }
                    },
                    yAxis: {
                        splitArea: { show: false }
                    },
                    grid: {
                        left: 100
                    },
                    series: [
                        {
                            name: 'Equity',
                            type: 'bar',
                            stack: 'one',
                            data: equity
                        },
                        {
                            name: 'Dividends',
                            type: 'bar',
                            stack: 'one',
                            data: alldivs
                        },
                        {
                            name: 'Result',
                            type: 'bar',
                            stack: 'one',
                            data: results
                        }
                    ]
                };

                myChart.setOption(option);

            },
            createStrategyPerformanceChart: function (element, dates, strategyLevels, baseLevels) {

                var myChart = echarts.init(element);

                option = {
                    legend: {
                        data: ['Strategy', 'Base'],
                        left: 10
                    },
                    xAxis: {
                        type: 'category',
                        data: dates
                    },
                    yAxis: { type: 'value' },
                    grid: { left: 100 },
                    series: [
                        {
                            name: 'Strategy',
                            data: strategyLevels,
                            type: 'line',
                            smooth: true,
                            symbol: 'none'
                        },
                        {
                            name: 'Base',
                            data: baseLevels,
                            type: 'line',
                            smooth: true,
                            symbol: 'none'
                        }
                    ]
                };

                myChart.setOption(option);

            },

            printPercent(val) { return new Intl.NumberFormat('ru-RU', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(val / 100); },
            tickerUrl(tickerId) { return `/ticker?id=${tickerId}&strategy=${window.strategyId}`; },
            industryUrl(industryId) { return '/industry/' + industryId; },

            factorDescr(rec) {
                for (var i = 0; i < this.renderInfo.ReportValues.length; i++) {
                    if (this.renderInfo.ReportValues[i].Id == rec.RK) {
                        return this.renderInfo.ReportValues[i].Descr;
                    }
                }
                return "";
            },

            daysForYear(year) {
                return this.results.Days.filter(item => item.D.startsWith(year.toString()) && (item.Refill != 0 || (item.Deals != null && item.Deals.length > 0)));
            },

            sumDivByYearForIndustry(aYear, aIndustryId) {
                let s = 0;
                this.results.IndustryDividendResults.forEach(
                    function (el) {
                        if (el.Industry.id == aIndustryId || aIndustryId == null) {
                            let v = el.ByYears[aYear];
                            if (v != null) s += v;
                        }
                    }
                );
                return s;
            },

            sumDivForIndustry(aIndustryId) {
                let s = 0;
                this.results.IndustryDividendResults.forEach(
                    function (el) {
                        if (el.Industry.id == aIndustryId) {
                            for (var y in el.ByYears) s += el.ByYears[y];
                        }
                    }
                );
                return s;
            },

            sumDivByYearForTicker(aYear, aTickerId) {
                let s = 0;
                this.results.TickerDividendResults.forEach(
                    function (el) {
                        if (el.Ticker.id == aTickerId) {
                            let v = el.ByYears[aYear];
                            if (v != null) s += v;
                        }
                    }
                );
                return s;

            },

            sumDivByYearForTickerAll(aYear) {
                let s = 0;
                this.results.TickerDividendResults.forEach(
                    function (el) {
                        let v = el.ByYears[aYear]
                        if (v != null) s += v;
                    }
                );
                return s;

            },

            sumAllYears(item) {
                let s = 0;
                for (y in item.ByYears) {
                    s += item.ByYears[y];
                }
                return s;
            },

            async getStrategy() {

                let res = await fetch(`?id=${window.strategyId}&mode=renderinfo`, { method: 'GET' });
                if (await res.ok) {
                    this.renderInfo = await res.json();
                } else {
                    alert("Error when get rendering info");
                    return;
                };

                res = await fetch(`?id=${window.strategyId}&mode=obj`, { method: 'GET' });
                if (await res.ok) {
                    this.obj = await res.json();

                    if (this.obj.edges.Filters == undefined)
                        this.obj.edges.Filters = [];

                    if (this.obj.edges.Factors == undefined)
                        this.obj.edges.Factors = [];

                    if (this.obj.edges.FixedTickers == undefined)
                        this.obj.edges.FixedTickers = [];

                }
                else alert("Error when get strategy data");

            },

            validateStrategy() {

                let shares = 0;
                this.obj.edges.FixedTickers.forEach(
                    function (el) { if (el.IsUsed) shares += +el.Share; }
                );

                if (shares > 100) {
                    alert("Total of all fixed shars cannot exceeds 100")
                    return false;
                }
                return true;
            },

            async putStrategy() {
                if (!this.validateStrategy()) return;

                this.obj.edges.FixedTickers.forEach(function (el) {
                    el.Share = parseInt(el.Share); //range editor returns string
                });

                this.obj.edges.Factors.forEach(function (el) {
                    el.MinAcceptable = el.MinAcceptable == "" || el.MinAcceptable == null ? null : parseInt(el.MinAcceptable);
                    el.MaxAcceptable = el.maxAcceptable == "" || el.MaxAcceptable == null ? null : parseInt(el.MaxAcceptable);
                });

                let objAsJson = JSON.stringify(this.obj);
                let res = await fetch(`?id=${window.strategyId}&mode=obj`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: objAsJson
                });
                if (await res.ok)
                    this.getResults();
                else
                    alert("Error when save strategy");
            },

            async getResults() {
                let response = await fetch(`?id=${window.strategyId}&mode=results`, { method: 'GET' });
                if (await response.ok) {
                    this.results = await response.json(); // charts will be rendered later by watch funcs
                    if (this.results.YearsInResult.length > 0)
                        this.selectedYear = this.results.YearsInResult[this.results.YearsInResult.length - 1];
                }
                else alert('Error when read simulation data');
            },

            setSelectedYear(y) { this.selectedYear = y; }
        }
    };

    let app = Vue.createApp(App)
    applyVueFuncs(app);
    app.mount('#vueapp')

</script>

{% endblock %}